<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL Health - AX Monitor</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- Sidebar Navigation -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <h2>üìä AX Monitor</h2>
                <div class="env-badge env-{{Environment}}">{{Environment}}</div>
            </div>
            <ul class="nav-menu">
                <li><a href="/"><span class="icon">üè†</span> Dashboard</a></li>
                <li><a href="/batch"><span class="icon">‚öôÔ∏è</span> Batch Jobs</a></li>
                <li><a href="/sessions"><span class="icon">üë•</span> Sessions</a></li>
                <li><a href="/blocking"><span class="icon">üîí</span> Blocking</a></li>
                <li><a href="/sql-health" class="active"><span class="icon">üíª</span> SQL Health</a></li>
                <li><a href="/alerts"><span class="icon">üö®</span> Alerts</a></li>
                <li><a href="/ai-assistant"><span class="icon">ü§ñ</span> AI Assistant</a></li>
            </ul>
            <div class="sidebar-footer">
                <p>Version {{Version}}</p>
                <p>Powered by Pode</p>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <header class="page-header">
                <h1>SQL Server Health</h1>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="refreshData()">
                        <span class="icon">üîÑ</span> Refresh
                    </button>
                    <div class="last-update">Last updated: <span id="lastUpdate">--:--:--</span></div>
                </div>
            </header>

            <!-- SQL Health KPI Cards -->
            <section class="kpi-section">
                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-icon" style="background: #1f77b4;">üìä</div>
                        <div class="kpi-content">
                            <h3>CPU Usage</h3>
                            <div class="kpi-value" id="cpuUsage">--%</div>
                            <div class="kpi-change" id="cpuUsageChange">--</div>
                        </div>
                    </div>
                    
                    <div class="kpi-card">
                        <div class="kpi-icon" style="background: #dc3545;">üß†</div>
                        <div class="kpi-content">
                            <h3>Memory Usage</h3>
                            <div class="kpi-value" id="memoryUsage">--%</div>
                            <div class="kpi-change" id="memoryUsageChange">--</div>
                        </div>
                    </div>
                    
                    <div class="kpi-card">
                        <div class="kpi-icon" style="background: #28a745;">üíæ</div>
                        <div class="kpi-content">
                            <h3>Disk Usage</h3>
                            <div class="kpi-value" id="diskUsage">--%</div>
                            <div class="kpi-change" id="diskUsageChange">--</div>
                        </div>
                    </div>
                    
                    <div class="kpi-card">
                        <div class="kpi-icon" style="background: #ffc107;">üìà</div>
                        <div class="kpi-content">
                            <h3>TDE Status</h3>
                            <div class="kpi-value" id="tdeStatus">--</div>
                            <div class="kpi-change" id="tdeStatusChange">--</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Health Details -->
            <section class="health-section">
                <div class="health-grid">
                    <div class="health-card">
                        <div class="health-icon">üîó</div>
                        <h3>Active Connections</h3>
                        <div class="health-value" id="activeConnections">--</div>
                        <div class="health-bar">
                            <div class="health-bar-fill" id="connectionsBar" style="width: 0%;"></div>
                        </div>
                    </div>
                    
                    <div class="health-card">
                        <div class="health-icon">‚è±Ô∏è</div>
                        <h3>Avg. Query Time</h3>
                        <div class="health-value" id="avgQueryTime">-- ms</div>
                    </div>
                    
                    <div class="health-card">
                        <div class="health-icon">üîß</div>
                        <h3>TempDB Usage</h3>
                        <div class="health-value" id="tempDbUsage">--%</div>
                        <div class="health-bar">
                            <div class="health-bar-fill" id="tempDbBar" style="width: 0%;"></div>
                        </div>
                    </div>
                    
                    <div class="health-card">
                        <div class="health-icon">‚è±Ô∏è</div>
                        <h3>Longest Query</h3>
                        <div class="health-value" id="longestQuery">-- min</div>
                    </div>
                </div>
            </section>

            <!-- Wait Statistics -->
            <section class="data-section">
                <h2>Wait Statistics</h2>
                <div class="wait-stats">
                    <div id="waitChartContainer" class="chart-container">
                        <canvas id="waitStatsChart"></canvas>
                    </div>
                    <div class="wait-stats-table">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Wait Type</th>
                                    <th>Wait Time (ms)</th>
                                    <th>Wait Count</th>
                                    <th>Signal Wait Time</th>
                                </tr>
                            </thead>
                            <tbody id="waitStatsBody">
                                <tr><td colspan="4" class="loading">Loading wait statistics...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Top Queries -->
            <section class="data-section">
                <h2>Top Expensive Queries</h2>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Query</th>
                                <th>CPU Time (ms)</th>
                                <th>Execution Count</th>
                                <th>Duration (ms)</th>
                                <th>Reads</th>
                                <th>Writes</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="queriesTableBody">
                            <tr><td colspan="7" class="loading">Loading top queries...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Charts -->
            <section class="charts-section">
                <div class="chart-grid">
                    <div class="chart-card">
                        <h3>CPU Usage Trend</h3>
                        <canvas id="cpuTrendChart"></canvas>
                    </div>
                    <div class="chart-card">
                        <h3>Memory Usage Trend</h3>
                        <canvas id="memoryTrendChart"></canvas>
                    </div>
                    <div class="chart-card">
                        <h3>Disk Usage Trend</h3>
                        <canvas id="diskTrendChart"></canvas>
                    </div>
                    <div class="chart-card">
                        <h3>Active Connections Trend</h3>
                        <canvas id="connectionsTrendChart"></canvas>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <script src="/static/js/dashboard.js"></script>
    <script>
        // Specific script for SQL health
        async function loadSQLHealthData() {
            try {
                const response = await axios.get('/api/sql-health');
                updateHealthKPIs(response.data);
                updateWaitStatistics(response.data.WaitStats || []);
                updateTopQueries(response.data.TopQueries || []);
            } catch (error) {
                console.error('Error loading SQL health data:', error);
                showError('Failed to load SQL health data');
            }
        }

        function updateHealthKPIs(data) {
            // Update KPI cards
            document.getElementById('cpuUsage').textContent = (data.CPUUsage || 0).toFixed(1) + '%';
            document.getElementById('memoryUsage').textContent = (data.MemoryUsage || 0).toFixed(1) + '%';
            document.getElementById('diskUsage').textContent = (data.DiskUsage || 0).toFixed(1) + '%';
            document.getElementById('tdeStatus').textContent = data.TDEStatus || 'Unknown';
            
            // Update health details
            document.getElementById('activeConnections').textContent = data.ActiveConnections || 0;
            document.getElementById('avgQueryTime').textContent = (data.AvgQueryTime || 0).toFixed(1) + ' ms';
            document.getElementById('tempDbUsage').textContent = (data.TempDBUsage || 0).toFixed(1) + '%';
            document.getElementById('longestQuery').textContent = (data.LongestQuery || 0).toFixed(1) + ' min';
            
            // Update health bars
            document.getElementById('connectionsBar').style.width = Math.min(data.ActiveConnections || 0, 100) + '%';
            document.getElementById('tempDbBar').style.width = (data.TempDBUsage || 0) + '%';
            
            // Set bar colors based on thresholds
            const cpuUsage = data.CPUUsage || 0;
            const memoryUsage = data.MemoryUsage || 0;
            const diskUsage = data.DiskUsage || 0;
            const tempDbUsage = data.TempDBUsage || 0;
            
            document.getElementById('connectionsBar').style.background = getHealthColor(data.ActiveConnections || 0, 50, 80);
            document.getElementById('tempDbBar').style.background = getHealthColor(tempDbUsage, 70, 90);
        }
        
        function updateWaitStatistics(waitStats) {
            const tableBody = document.getElementById('waitStatsBody');
            
            if (!waitStats || waitStats.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" class="no-data">No wait statistics available</td></tr>';
                return;
            }

            // Sort by wait time descending
            const sortedWaitStats = [...waitStats].sort((a, b) => (b.WaitTimeMs || 0) - (a.WaitTimeMs || 0));
            
            const rows = sortedWaitStats.map(wait => {
                return `
                    <tr>
                        <td>${wait.WaitType || '--'}</td>
                        <td>${wait.WaitTimeMs?.toLocaleString() || '--'}</td>
                        <td>${wait.WaitCount?.toLocaleString() || '--'}</td>
                        <td>${wait.SignalWaitTimeMs?.toLocaleString() || '--'}</td>
                    </tr>
                `;
            }).join('');
            
            tableBody.innerHTML = rows;
        }
        
        function updateTopQueries(queries) {
            const tableBody = document.getElementById('queriesTableBody');
            
            if (!queries || queries.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" class="no-data">No queries available</td></tr>';
                return;
            }

            // Sort by CPU time descending
            const sortedQueries = [...queries].sort((a, b) => (b.CPUTime || 0) - (a.CPUTime || 0));
            
            const rows = sortedQueries.map(query => {
                // Truncate query text for display
                const queryText = query.QueryText ? 
                    (query.QueryText.length > 50 ? query.QueryText.substring(0, 50) + '...' : query.QueryText) 
                    : '--';
                
                return `
                    <tr>
                        <td title="${query.QueryText || ''}">${queryText}</td>
                        <td>${query.CPUTime?.toLocaleString() || '--'}</td>
                        <td>${query.ExecutionCount?.toLocaleString() || '--'}</td>
                        <td>${query.Duration?.toLocaleString() || '--'}</td>
                        <td>${query.Reads?.toLocaleString() || '--'}</td>
                        <td>${query.Writes?.toLocaleString() || '--'}</td>
                        <td>
                            <button class="btn btn-small btn-secondary" onclick="showQueryDetails('${query.QueryId}')">Details</button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            tableBody.innerHTML = rows;
        }
        
        function showQueryDetails(queryId) {
            alert(`Query details for ID: ${queryId}`);
            // In a real implementation, this would show detailed query information
        }
        
        function getHealthColor(value, warningThreshold, criticalThreshold) {
            if (value >= criticalThreshold) return '#dc3545'; // red
            if (value >= warningThreshold) return '#ffc107'; // yellow
            return '#28a745'; // green
        }
        
        // Override refreshData function for SQL health-specific loading
        function refreshData() {
            loadSQLHealthData();
            updateTimestamp();
        }
        
        // Load data when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadSQLHealthData();
            // Set up auto-refresh every 30 seconds
            setInterval(loadSQLHealthData, 30000);
        });
    </script>
</body>
</html>