@page "/trend-analysis"
@using AXMonitoringBU.Blazor.Services
@using AXMonitoringBU.Blazor.Components
@inject IMetricsService MetricsService
@inject ILogger<TrendAnalysis> Logger

<PageTitle>Trend Analysis - AX Monitoring BU</PageTitle>

<h3>ðŸ“ˆ Trend Analysis</h3>

<div class="row mb-4">
    <div class="col-md-3">
        <label class="form-label">Select Metric</label>
        <select class="form-select" @bind="selectedMetric">
            <option value="cpu_usage">CPU Usage</option>
            <option value="memory_usage">Memory Usage</option>
            <option value="active_sessions">Active Sessions</option>
            <option value="error_rate">Error Rate</option>
            <option value="blocking_chains">Blocking Chains</option>
        </select>
    </div>
    <div class="col-md-3">
        <label class="form-label">Time Range</label>
        <select class="form-select" @bind="timeRange">
            <option value="24h">24 hours</option>
            <option value="7d">7 days</option>
            <option value="30d">30 days</option>
            <option value="90d">90 days</option>
        </select>
    </div>
    <div class="col-md-3 d-flex align-items-end">
        <button class="btn btn-primary" @onclick="AnalyzeTrends">ðŸ”„ Analyze Trends</button>
    </div>
</div>

@if (isLoading)
{
    <p>Loading...</p>
}
else
{
    <div class="row mb-4">
        <div class="col-md-3">
            <MetricCard Title="Current Value" Value="@(trendData?.currentValue.ToString("F1") ?? "N/A")" Color="#1f77b4" />
        </div>
        <div class="col-md-3">
            <MetricCard Title="Trend" Value="@(trendData?.trendDirection ?? "N/A")" Color="@(trendData?.trendDirection == "Increasing" ? "#dc3545" : "#28a745")" />
        </div>
        <div class="col-md-3">
            <MetricCard Title="Volatility" Value="@(trendData?.volatility.ToString("F2") ?? "N/A")" Color="#17a2b8" />
        </div>
        <div class="col-md-3">
            <MetricCard Title="Anomalies" Value="@(trendData?.anomaliesCount.ToString() ?? "0")" Color="#ffc107" />
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <h4>ðŸ“Š Trend Chart</h4>
            <div class="card">
                <div class="card-body">
                    <ChartComponent ChartId="trendChart" ChartType="line" Data="@trendChartData" Options="@trendChartOptions" />
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5>ðŸ“‹ Detailed Analysis</h5>
                </div>
                <div class="card-body">
                    <p><strong>Mean:</strong> @(trendData?.mean.ToString("F2") ?? "N/A")</p>
                    <p><strong>Min:</strong> @(trendData?.min.ToString("F2") ?? "N/A")</p>
                    <p><strong>Max:</strong> @(trendData?.max.ToString("F2") ?? "N/A")</p>
                    <p><strong>Standard Deviation:</strong> @(trendData?.stdDev.ToString("F2") ?? "N/A")</p>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private bool isLoading = true;
    private string selectedMetric = "cpu_usage";
    private string timeRange = "24h";
    private TrendData? trendData;
    private ChartData? trendChartData;
    private ChartOptions? trendChartOptions;

    protected override async Task OnInitializedAsync()
    {
        await AnalyzeTrends();
    }

    private async Task AnalyzeTrends()
    {
        isLoading = true;
        try
        {
            var metrics = await MetricsService.GetCurrentMetricsAsync();
            
            // Fetch historical data from API
            var historyResponse = await MetricsService.GetMetricsHistoryAsync(selectedMetric, timeRange);
            var historicalData = historyResponse?.data?.Select(d => d.value).ToList() ?? new List<double>();
            var labels = historyResponse?.data?.Select(d => FormatTimestamp(d.timestamp, timeRange)).ToList() ?? new List<string>();
            
            if (!historicalData.Any())
            {
                // Fallback to mock data if API returns empty
                var mockData = GenerateMockHistoricalData(selectedMetric, timeRange);
                historicalData = mockData.values;
                labels = mockData.labels;
            }
            
            trendData = new TrendData
            {
                currentValue = selectedMetric switch
                {
                    "cpu_usage" => metrics?.sql_health?.cpu_usage ?? 0,
                    "memory_usage" => metrics?.sql_health?.memory_usage ?? 0,
                    "active_sessions" => metrics?.kpis?.active_sessions ?? 0,
                    "error_rate" => metrics?.kpis?.error_rate ?? 0,
                    "blocking_chains" => metrics?.kpis?.blocking_chains ?? 0,
                    _ => 0
                },
                trendDirection = historicalData.Count > 1 && historicalData.Last() > historicalData.First() ? "Increasing" : "Decreasing",
                volatility = CalculateVolatility(historicalData),
                anomaliesCount = 2,
                mean = historicalData.Any() ? historicalData.Average() : 0,
                min = historicalData.Any() ? historicalData.Min() : 0,
                max = historicalData.Any() ? historicalData.Max() : 0,
                stdDev = CalculateStdDev(historicalData)
            };

            // Create chart data
            trendChartData = new ChartData
            {
                Labels = labels,
                Datasets = new List<ChartDataset>
                {
                    new ChartDataset
                    {
                        Label = GetMetricLabel(selectedMetric),
                        Data = historicalData,
                        BackgroundColor = "rgba(31, 119, 180, 0.2)",
                        BorderColor = "rgba(31, 119, 180, 1)",
                        BorderWidth = 2
                    }
                }
            };

            trendChartOptions = new ChartOptions
            {
                Responsive = true,
                Plugins = new ChartPlugins
                {
                    Legend = new ChartLegend { Display = true, Position = "top" },
                    Title = new ChartTitle { Display = true, Text = $"Trend Analysis: {GetMetricLabel(selectedMetric)}" }
                },
                Scales = new ChartScales
                {
                    Y = new ChartAxis { BeginAtZero = true }
                }
            };
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error analyzing trends: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private (List<string> labels, List<double> values) GenerateMockHistoricalData(string metric, string range)
    {
        var labels = new List<string>();
        var values = new List<double>();
        var random = new Random();
        
        int pointCount = range switch
        {
            "24h" => 24,
            "7d" => 7,
            "30d" => 30,
            "90d" => 90,
            _ => 24
        };

        var baseValue = metric switch
        {
            "cpu_usage" => 50.0,
            "memory_usage" => 60.0,
            "active_sessions" => 100.0,
            "error_rate" => 1.5,
            "blocking_chains" => 2.0,
            _ => 50.0
        };

        for (int i = 0; i < pointCount; i++)
        {
            labels.Add(range switch
            {
                "24h" => DateTime.Now.AddHours(-pointCount + i).ToString("HH:mm"),
                "7d" => DateTime.Now.AddDays(-pointCount + i).ToString("MM/dd"),
                "30d" => DateTime.Now.AddDays(-pointCount + i).ToString("MM/dd"),
                "90d" => DateTime.Now.AddDays(-pointCount + i).ToString("MM/dd"),
                _ => i.ToString()
            });
            
            var variation = (random.NextDouble() - 0.5) * 20;
            values.Add(Math.Max(0, baseValue + variation));
        }

        return (labels, values);
    }

    private double CalculateVolatility(List<double> values)
    {
        if (values.Count < 2) return 0;
        var mean = values.Average();
        var variance = values.Sum(v => Math.Pow(v - mean, 2)) / values.Count;
        return Math.Sqrt(variance) / mean;
    }

    private double CalculateStdDev(List<double> values)
    {
        if (values.Count < 2) return 0;
        var mean = values.Average();
        var variance = values.Sum(v => Math.Pow(v - mean, 2)) / values.Count;
        return Math.Sqrt(variance);
    }

    private string FormatTimestamp(DateTime timestamp, string range) => range switch
    {
        "24h" => timestamp.ToString("HH:mm"),
        "7d" => timestamp.ToString("MM/dd"),
        "30d" => timestamp.ToString("MM/dd"),
        "90d" => timestamp.ToString("MM/dd"),
        _ => timestamp.ToString("HH:mm")
    };

    private string GetMetricLabel(string metric) => metric switch
    {
        "cpu_usage" => "CPU Usage (%)",
        "memory_usage" => "Memory Usage (%)",
        "active_sessions" => "Active Sessions",
        "error_rate" => "Error Rate (%)",
        "blocking_chains" => "Blocking Chains",
        _ => metric
    };

    private class TrendData
    {
        public double currentValue { get; set; }
        public string trendDirection { get; set; } = string.Empty;
        public double volatility { get; set; }
        public int anomaliesCount { get; set; }
        public double mean { get; set; }
        public double min { get; set; }
        public double max { get; set; }
        public double stdDev { get; set; }
    }
}

