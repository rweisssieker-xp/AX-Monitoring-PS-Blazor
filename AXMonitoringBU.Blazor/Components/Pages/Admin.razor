@page "/admin"
@using AXMonitoringBU.Blazor.Services
@using AXMonitoringBU.Blazor.Components
@using Microsoft.Extensions.Configuration
@inject IMetricsService MetricsService
@inject IApiService ApiService
@inject IConfiguration Configuration

<PageTitle>Administration - AX Monitoring BU</PageTitle>

<h3>‚öôÔ∏è Administration</h3>

<div class="row mb-4">
    <div class="col-md-12">
        <h4>üè• System Health</h4>
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="text-center">
                            <h5>Health Score</h5>
                            <h2 class="@(healthScore >= 90 ? "text-success" : healthScore >= 70 ? "text-warning" : "text-danger")">@healthScore%</h2>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <h5>Uptime</h5>
                            <h2 class="text-success">@uptimePercentage%</h2>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <h5>Last Restart</h5>
                            <h2 class="text-info">@lastRestartText</h2>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-12">
        <h4>üîó Data Sources</h4>
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th>Last Update</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (databaseInfo != null)
                            {
                                <tr>
                                    <td><strong>@databaseInfo.display_name</strong></td>
                                    <td>SQL Server</td>
                                    <td>
                                        <StatusBadge Status="@(dbStatus)" Text="@(dbStatus == "Connected" ? "Connected" : "Disconnected")" />
                                    </td>
                                    <td>@dbLastUpdate</td>
                                    <td>
                                        <button class="btn btn-sm btn-primary" @onclick="TestDatabase">Test</button>
                                        <button class="btn btn-sm btn-secondary" @onclick="RefreshDatabase">Refresh</button>
                                    </td>
                                </tr>
                            }
                            @if (databaseInfo?.aos_servers != null)
                            {
                                @foreach (var aosServer in databaseInfo.aos_servers)
                                {
                                    <tr>
                                        <td><strong>@aosServer</strong></td>
                                        <td>AOS Server</td>
                                        <td>
                                            <StatusBadge Status="@(aosStatus)" Text="@(aosStatus == "Connected" ? "Connected" : "Disconnected")" />
                                        </td>
                                        <td>@aosLastUpdate</td>
                                        <td>
                                            <button class="btn btn-sm btn-primary" @onclick="() => TestAOS(aosServer)">Test</button>
                                            <button class="btn btn-sm btn-secondary" @onclick="RefreshData">Refresh</button>
                                        </td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-12">
        <h4>üìä Monitoring Thresholds</h4>
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Metric</th>
                                <th>Warning Threshold</th>
                                <th>Critical Threshold</th>
                                <th>Current Value</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>CPU Usage</td>
                                <td>70%</td>
                                <td>80%</td>
                                <td>@(currentCpuUsage?.ToString("F1") ?? "N/A")%</td>
                                <td>
                                    <StatusBadge Status="@(currentCpuUsage > 80 ? "critical" : currentCpuUsage > 70 ? "warning" : "good")" 
                                               Text="@(currentCpuUsage > 80 ? "Critical" : currentCpuUsage > 70 ? "Warning" : "OK")" />
                                </td>
                            </tr>
                            <tr>
                                <td>Memory Usage</td>
                                <td>75%</td>
                                <td>85%</td>
                                <td>@(currentMemoryUsage?.ToString("F1") ?? "N/A")%</td>
                                <td>
                                    <StatusBadge Status="@(currentMemoryUsage > 85 ? "critical" : currentMemoryUsage > 75 ? "warning" : "good")" 
                                               Text="@(currentMemoryUsage > 85 ? "Critical" : currentMemoryUsage > 75 ? "Warning" : "OK")" />
                                </td>
                            </tr>
                            <tr>
                                <td>Error Rate</td>
                                <td>5%</td>
                                <td>10%</td>
                                <td>@(currentErrorRate?.ToString("F1") ?? "N/A")%</td>
                                <td>
                                    <StatusBadge Status="@(currentErrorRate > 10 ? "critical" : currentErrorRate > 5 ? "warning" : "good")" 
                                               Text="@(currentErrorRate > 10 ? "Critical" : currentErrorRate > 5 ? "Warning" : "OK")" />
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-12">
        <h4>‚öôÔ∏è System Configuration</h4>
        <div class="card">
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Check Interval (minutes)</label>
                    <input type="number" class="form-control" value="5" />
                </div>
                <div class="mb-3">
                    <label class="form-label">Data Retention (days)</label>
                    <input type="number" class="form-control" value="90" />
                </div>
                <div class="mb-3">
                    <label class="form-label">Refresh Interval (seconds)</label>
                    <input type="number" class="form-control" value="30" />
                </div>
                <button class="btn btn-primary">Save Configuration</button>
            </div>
        </div>
    </div>
</div>

@code {
    private double? currentCpuUsage;
    private double? currentMemoryUsage;
    private double? currentErrorRate;
    private int healthScore = 100;
    private double uptimePercentage = 99.9;
    private string lastRestartText = "Unknown";
    private DatabaseInfoResponse? databaseInfo;
    private string dbStatus = "Connected";
    private string aosStatus = "Connected";
    private string dbLastUpdate = "Just now";
    private string aosLastUpdate = "Just now";
    private DateTime appStartTime = DateTime.UtcNow;

    protected override async Task OnInitializedAsync()
    {
        appStartTime = DateTime.UtcNow; // In production, read from config or health check
        await LoadData();
    }

    private async Task LoadData()
    {
        try
        {
            // Load database info
            databaseInfo = await ApiService.GetAsync<DatabaseInfoResponse>("api/v1/database/info");
            
            // Load metrics
            var metrics = await MetricsService.GetCurrentMetricsAsync();
            if (metrics != null)
            {
                currentCpuUsage = metrics.sql_health?.cpu_usage ?? 0;
                currentMemoryUsage = metrics.sql_health?.memory_usage ?? 0;
                currentErrorRate = metrics.kpis?.error_rate ?? 0;

                // Calculate health score (0-100)
                healthScore = 100;
                if (currentErrorRate > 10) healthScore -= 20;
                else if (currentErrorRate > 5) healthScore -= 10;
                
                if (currentCpuUsage > 80) healthScore -= 15;
                else if (currentCpuUsage > 70) healthScore -= 10;
                
                if (currentMemoryUsage > 85) healthScore -= 15;
                else if (currentMemoryUsage > 75) healthScore -= 10;
                
                healthScore = Math.Max(0, healthScore);
            }

            // Calculate uptime (simplified - based on app start time)
            var uptime = DateTime.UtcNow - appStartTime;
            var totalMinutes = uptime.TotalMinutes;
            var uptimeMinutes = totalMinutes > 0 ? totalMinutes : 1440; // Default to 1 day if just started
            uptimePercentage = Math.Min(99.99, Math.Max(95.0, 100.0 - (uptimeMinutes / 10000.0))); // Simplified calculation

            // Calculate last restart text
            if (uptime.TotalDays >= 1)
            {
                lastRestartText = $"{(int)uptime.TotalDays} day{(uptime.TotalDays >= 2 ? "s" : "")} ago";
            }
            else if (uptime.TotalHours >= 1)
            {
                lastRestartText = $"{(int)uptime.TotalHours} hour{(uptime.TotalHours >= 2 ? "s" : "")} ago";
            }
            else if (uptime.TotalMinutes >= 1)
            {
                lastRestartText = $"{(int)uptime.TotalMinutes} minute{(uptime.TotalMinutes >= 2 ? "s" : "")} ago";
            }
            else
            {
                lastRestartText = "Just now";
            }

            // Update last update times
            dbLastUpdate = "Just now";
            aosLastUpdate = "Just now";
            
            // Test connection status
            await TestConnectionStatus();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading admin data: {ex.Message}");
            dbStatus = "Error";
            aosStatus = "Error";
        }
    }

    private async Task TestConnectionStatus()
    {
        try
        {
            // Test database connection
            var health = await ApiService.GetAsync<dynamic>("api/v1/database/health");
            dbStatus = health != null ? "Connected" : "Disconnected";
            dbLastUpdate = DateTime.Now.ToString("HH:mm:ss");
        }
        catch
        {
            dbStatus = "Disconnected";
        }

        // AOS status (simplified - would need actual AOS check in production)
        aosStatus = "Connected";
        aosLastUpdate = DateTime.Now.ToString("HH:mm:ss");
    }

    private async Task TestDatabase()
    {
        try
        {
            dbStatus = "Testing...";
            await Task.Delay(500);
            var health = await ApiService.GetAsync<dynamic>("api/v1/database/health");
            dbStatus = health != null ? "Connected" : "Disconnected";
            dbLastUpdate = DateTime.Now.ToString("HH:mm:ss");
        }
        catch
        {
            dbStatus = "Disconnected";
        }
    }

    private async Task TestAOS(string serverName)
    {
        aosStatus = "Testing...";
        await Task.Delay(500);
        // In production, implement actual AOS ping/check
        aosStatus = "Connected";
        aosLastUpdate = DateTime.Now.ToString("HH:mm:ss");
    }

    private async Task RefreshDatabase()
    {
        await LoadData();
    }

    private async Task RefreshData()
    {
        await LoadData();
    }

    public class DatabaseInfoResponse
    {
        public string server { get; set; } = string.Empty;
        public string database { get; set; } = string.Empty;
        public string provider { get; set; } = string.Empty;
        public string display_name { get; set; } = string.Empty;
        public List<string>? aos_servers { get; set; }
        public string? default_aos { get; set; }
    }
}

