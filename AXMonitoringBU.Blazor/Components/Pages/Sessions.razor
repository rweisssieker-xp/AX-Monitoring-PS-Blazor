@page "/sessions"
@using AXMonitoringBU.Blazor.Services
@using AXMonitoringBU.Blazor.Components
@inject ISessionService SessionService

<PageTitle>Sessions - AX Monitoring BU</PageTitle>

<h3>üë• Sessions Monitor</h3>

<div class="mb-3">
    <button class="btn btn-primary" @onclick="RefreshData">üîÑ Refresh Data</button>
</div>

@if (isLoading)
{
    <p>Loading...</p>
}
else
{
    <div class="row mb-4">
        <div class="col-md-3">
            <MetricCard Title="Total Sessions" Value="@totalSessions.ToString()" Color="#1f77b4" />
        </div>
        <div class="col-md-3">
            <MetricCard Title="Active" Value="@activeSessions.ToString()" Color="#28a745" Delta="@($"+{activeSessions}")" />
        </div>
        <div class="col-md-3">
            <MetricCard Title="Idle" Value="@idleSessions.ToString()" Color="#ffc107" Delta="@($"+{idleSessions}")" />
        </div>
        <div class="col-md-3">
            <MetricCard Title="Avg Duration (min)" Value="@avgDuration.ToString()" Color="#17a2b8" />
        </div>
    </div>

    @if (longRunningSessions.Any())
    {
        <div class="alert alert-warning mb-4">
            <h5>‚ö†Ô∏è Long Running Sessions</h5>
            <ul class="mb-0">
                @foreach (var session in longRunningSessions)
                {
                    var duration = DateTime.Now - session.LoginTime;
                    <li>Session @session.SessionId (@session.UserId) has been running for @(duration.Hours) hours</li>
                }
            </ul>
        </div>
    }

    <div class="row mb-4">
        <div class="col-12">
            <h4>üìã Sessions Details</h4>
            @if (sessions != null && sessions.Any())
            {
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Session ID</th>
                                <th>User</th>
                                <th>AOS Server</th>
                                <th>Status</th>
                                <th>Database</th>
                                <th>Login Time</th>
                                <th>Duration</th>
                                <th>Last Activity</th>
                                <th>Idle Time</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var session in sessions)
                            {
                                var duration = DateTime.Now - session.LoginTime;
                                var idleTime = session.LastActivity.HasValue ? DateTime.Now - session.LastActivity.Value : TimeSpan.Zero;
                                <tr>
                                    <td>@session.SessionId</td>
                                    <td>@session.UserId</td>
                                    <td>@session.AosServer</td>
                                    <td><StatusBadge Status="@session.Status" Text="@session.Status" /></td>
                                    <td>@session.Database</td>
                                    <td>@session.LoginTime.ToString("HH:mm:ss")</td>
                                    <td>@(duration.TotalMinutes.ToString("F0")) min</td>
                                    <td>@(session.LastActivity?.ToString("HH:mm:ss") ?? "N/A")</td>
                                    <td>@(idleTime.TotalMinutes.ToString("F0")) min</td>
                                    <td>
                                        <button class="btn btn-sm btn-danger" @onclick="() => KillSession(session.Id)">Kill</button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="alert alert-info">No sessions found</div>
            }
        </div>
    </div>
}

@code {
    private bool isLoading = true;
    private List<SessionDto>? sessions;
    private int totalSessions => sessions?.Count ?? 0;
    private int activeSessions => sessions?.Count(s => s.Status == "Active") ?? 0;
    private int idleSessions => sessions?.Count(s => s.Status == "Idle") ?? 0;
    private int avgDuration => sessions?.Any() == true 
        ? (int)sessions.Average(s => (DateTime.Now - s.LoginTime).TotalMinutes) 
        : 0;
    private List<SessionDto> longRunningSessions => sessions?
        .Where(s => (DateTime.Now - s.LoginTime).TotalHours > 1)
        .ToList() ?? new List<SessionDto>();

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        isLoading = true;
        try
        {
            var response = await SessionService.GetSessionsAsync();
            sessions = response?.sessions;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading sessions: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task RefreshData()
    {
        await LoadData();
    }

    private async Task KillSession(int sessionId)
    {
        try
        {
            var success = await SessionService.KillSessionAsync(sessionId);
            if (success)
            {
                await LoadData(); // Refresh the list
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error killing session: {ex.Message}");
        }
    }
}

