@page "/system-load-analytics"
@using AXMonitoringBU.Blazor.Services
@using AXMonitoringBU.Blazor.Models
@inject ISystemLoadAnalyticsService SystemLoadAnalyticsService

<PageTitle>System Load Analytics - AX Monitoring BU</PageTitle>

<h3>üìä System Load Analytics</h3>

<div class="mb-3">
    <div class="row">
        <div class="col-md-3">
            <label>Start Date:</label>
            <input type="date" class="form-control" @bind="startDate" />
        </div>
        <div class="col-md-3">
            <label>End Date:</label>
            <input type="date" class="form-control" @bind="endDate" />
        </div>
        <div class="col-md-3">
            <label>Granularity:</label>
            <select class="form-select" @bind="granularity">
                <option value="hourly">Hourly</option>
                <option value="daily">Daily</option>
                <option value="weekly">Weekly</option>
            </select>
        </div>
        <div class="col-md-3">
            <label>&nbsp;</label>
            <button class="btn btn-primary d-block w-100" @onclick="RefreshData">üîÑ Refresh Data</button>
        </div>
    </div>
</div>

@if (isLoading)
{
    <div class="text-center my-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading system load analytics...</p>
    </div>
}
else if (summary != null)
{
    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h6 class="card-title">Total Jobs</h6>
                    <h3>@summary.TotalJobsExecuted</h3>
                    <small>@summary.PeriodStart.ToString("dd.MM.yyyy") - @summary.PeriodEnd.ToString("dd.MM.yyyy")</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-danger text-white">
                <div class="card-body">
                    <h6 class="card-title">Total Errors</h6>
                    <h3>@summary.TotalErrors</h3>
                    <small>Error Rate: @summary.ErrorRate.ToString("F2")%</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h6 class="card-title">Peak Concurrent Jobs</h6>
                    <h3>@summary.PeakConcurrentJobs</h3>
                    <small>@summary.PeakLoadTime.ToString("dd.MM HH:mm")</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <h6 class="card-title">Avg CPU Usage</h6>
                    <h3>@summary.AvgCpuUsage.ToString("F1")%</h3>
                    <small>Avg Memory: @summary.AvgMemoryUsage.ToString("F1")%</small>
                </div>
            </div>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(summary.CapacityRecommendation))
    {
        <div class="alert alert-info mb-4">
            <strong>Capacity Recommendation:</strong> @summary.CapacityRecommendation
        </div>
    }

    <!-- AOS Server Distribution -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5>üñ•Ô∏è AOS Server Distribution</h5>
                </div>
                <div class="card-body">
                    @if (aosServers != null && aosServers.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Server Name</th>
                                        <th>Total Jobs</th>
                                        <th>Running Jobs</th>
                                        <th>Errors</th>
                                        <th>Avg Duration (min)</th>
                                        <th>Load %</th>
                                        <th>Health Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var server in aosServers)
                                    {
                                        <tr>
                                            <td><strong>@server.ServerName</strong></td>
                                            <td>@server.TotalJobs</td>
                                            <td>@server.RunningJobs</td>
                                            <td><span class="badge bg-danger">@server.ErrorCount</span></td>
                                            <td>@server.AvgJobDuration.ToString("F1")</td>
                                            <td>
                                                <div class="progress">
                                                    <div class="progress-bar @GetLoadBarColor(server.LoadPercentage)"
                                                         role="progressbar"
                                                         style="width: @(server.LoadPercentage)%"
                                                         aria-valuenow="@server.LoadPercentage"
                                                         aria-valuemin="0"
                                                         aria-valuemax="100">
                                                        @server.LoadPercentage.ToString("F0")%
                                                    </div>
                                                </div>
                                            </td>
                                            <td><span class="badge @GetHealthBadgeClass(server.HealthStatus)">@server.HealthStatus</span></td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <p class="text-muted">No server data available</p>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Load Heatmap -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5>üî• Load Heatmap (@granularity)</h5>
                </div>
                <div class="card-body">
                    @if (heatmapData != null && heatmapData.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered">
                                <thead>
                                    <tr>
                                        <th>Time</th>
                                        <th>Job Count</th>
                                        <th>Errors</th>
                                        <th>Avg CPU %</th>
                                        <th>Avg Memory %</th>
                                        <th>Peak Concurrent</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var data in heatmapData.Take(20))
                                    {
                                        <tr class="@GetHeatmapRowClass(data.ErrorCount, data.JobCount)">
                                            <td>@data.Timestamp.ToString("dd.MM.yyyy HH:mm")</td>
                                            <td>@data.JobCount</td>
                                            <td>@data.ErrorCount</td>
                                            <td>@data.AvgCpuUsage.ToString("F1")%</td>
                                            <td>@data.AvgMemoryUsage.ToString("F1")%</td>
                                            <td>@data.PeakConcurrentJobs</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                        @if (heatmapData.Count > 20)
                        {
                            <p class="text-muted mt-2">Showing first 20 of @heatmapData.Count time buckets</p>
                        }
                    }
                    else
                    {
                        <p class="text-muted">No heatmap data available</p>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Resource Trends -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5>üìà Resource Trends</h5>
                </div>
                <div class="card-body">
                    @if (resourceTrends != null && resourceTrends.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-sm table-striped">
                                <thead>
                                    <tr>
                                        <th>Timestamp</th>
                                        <th>CPU %</th>
                                        <th>Memory %</th>
                                        <th>IO Wait (ms)</th>
                                        <th>TempDB %</th>
                                        <th>Connections</th>
                                        <th>Active Jobs</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var trend in resourceTrends.Take(15))
                                    {
                                        <tr>
                                            <td>@trend.Timestamp.ToString("dd.MM HH:mm")</td>
                                            <td>@trend.CpuUsage.ToString("F1")%</td>
                                            <td>@trend.MemoryUsage.ToString("F1")%</td>
                                            <td>@trend.IoWait.ToString("F1")</td>
                                            <td>@trend.TempDbUsage.ToString("F1")%</td>
                                            <td>@trend.ActiveConnections</td>
                                            <td>@trend.ActiveBatchJobs</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                        @if (resourceTrends.Count > 15)
                        {
                            <p class="text-muted mt-2">Showing first 15 of @resourceTrends.Count data points</p>
                        }
                    }
                    else
                    {
                        <p class="text-muted">No resource trend data available</p>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Parallel Execution Metrics -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5>‚ö° Parallel Execution Metrics</h5>
                </div>
                <div class="card-body">
                    @if (parallelMetrics != null && parallelMetrics.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-sm table-striped">
                                <thead>
                                    <tr>
                                        <th>Timestamp</th>
                                        <th>Concurrent Jobs</th>
                                        <th>Queued Jobs</th>
                                        <th>Avg Wait Time (min)</th>
                                        <th>Capacity Utilization %</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var metric in parallelMetrics.Take(15))
                                    {
                                        <tr>
                                            <td>@metric.Timestamp.ToString("dd.MM HH:mm")</td>
                                            <td>@metric.ConcurrentJobs</td>
                                            <td>@metric.QueuedJobs</td>
                                            <td>@metric.AvgWaitTime.ToString("F1")</td>
                                            <td>
                                                <div class="progress">
                                                    <div class="progress-bar @GetCapacityBarColor(metric.CapacityUtilization)"
                                                         role="progressbar"
                                                         style="width: @(metric.CapacityUtilization)%"
                                                         aria-valuenow="@metric.CapacityUtilization"
                                                         aria-valuemin="0"
                                                         aria-valuemax="100">
                                                        @metric.CapacityUtilization.ToString("F0")%
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                        @if (parallelMetrics.Count > 15)
                        {
                            <p class="text-muted mt-2">Showing first 15 of @parallelMetrics.Count data points</p>
                        }
                    }
                    else
                    {
                        <p class="text-muted">No parallel execution data available</p>
                    }
                </div>
            </div>
        </div>
    </div>
}

@code {
    private bool isLoading = true;
    private DateTime startDate = DateTime.Now.AddDays(-7);
    private DateTime endDate = DateTime.Now;
    private string granularity = "daily";

    private SystemLoadSummaryDto? summary;
    private List<LoadHeatmapDataDto> heatmapData = new();
    private List<AosServerLoadDto> aosServers = new();
    private List<ResourceTrendDataDto> resourceTrends = new();
    private List<ParallelExecutionDataDto> parallelMetrics = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        isLoading = true;
        try
        {
            // Load all data in parallel
            var summaryTask = SystemLoadAnalyticsService.GetSystemLoadSummaryAsync(startDate, endDate);
            var heatmapTask = SystemLoadAnalyticsService.GetLoadHeatmapAsync(startDate, endDate, granularity);
            var serversTask = SystemLoadAnalyticsService.GetAosServerDistributionAsync(startDate, endDate);
            var trendsTask = SystemLoadAnalyticsService.GetResourceTrendsAsync(startDate, endDate);
            var parallelTask = SystemLoadAnalyticsService.GetParallelExecutionMetricsAsync(startDate, endDate);

            await Task.WhenAll(summaryTask, heatmapTask, serversTask, trendsTask, parallelTask);

            summary = await summaryTask;
            heatmapData = await heatmapTask;
            aosServers = await serversTask;
            resourceTrends = await trendsTask;
            parallelMetrics = await parallelTask;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading system load analytics: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task RefreshData()
    {
        await LoadData();
    }

    private string GetHealthBadgeClass(string healthStatus) => healthStatus switch
    {
        "Healthy" => "bg-success",
        "Warning" => "bg-warning",
        "Critical" => "bg-danger",
        _ => "bg-secondary"
    };

    private string GetLoadBarColor(double loadPercentage) => loadPercentage switch
    {
        < 50 => "bg-success",
        < 75 => "bg-warning",
        _ => "bg-danger"
    };

    private string GetCapacityBarColor(double capacity) => capacity switch
    {
        < 60 => "bg-success",
        < 80 => "bg-warning",
        _ => "bg-danger"
    };

    private string GetHeatmapRowClass(int errorCount, int jobCount)
    {
        if (errorCount == 0) return "";
        var errorRate = jobCount > 0 ? (double)errorCount / jobCount * 100 : 0;
        return errorRate switch
        {
            < 5 => "table-warning",
            < 10 => "table-danger",
            _ => "table-danger"
        };
    }
}
